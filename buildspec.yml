version: 0.2

env:
  variables:
    OPS: operations
    SCRIPTS: |
      operations/scripts/lambda.js

phases:
  install:
    commands:
    - pip install --upgrade pip
    - pip install yamllint
    - pip install demjson
  pre_build:
    commands:
    - yamllint .
    - |
      find . -type f -name '*.json' | while read file; do
        set -ex && jsonlint "$file"
      done
    - |
      find "$OPS" -type f -name "*.yml" | while read file; do
        aws s3 cp "$file" "s3://$TEMPLATE_BUCKET/Validation/$file"
        set -ex && aws cloudformation validate-template --template-url "https://s3.amazonaws.com/$TEMPLATE_BUCKET/Validation/$file"
      done
  build:
    commands:
    - ls -la
    - echo "Copying scripts to S3"
    - |
      for script in "$SCRIPTS"; do
        aws s3 cp "$script" "s3://$TEMPLATE_BUCKET/$script"
      done
    - echo "Building templates..."

artifacts:
  files:
  - 'operations/*'
